<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Card Collector Activity</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #111; color: #eee; }
    header { background: #222; padding: 1rem; text-align: center; font-size: 1.5rem; border-bottom: 2px solid #333; }
    nav { display: flex; justify-content: center; gap: 1rem; background: #1b1b1b; padding: .5rem; }
    nav button { background: #333; color: #eee; border: none; padding: .5rem 1rem; cursor: pointer; border-radius: 5px; }
    nav button:hover { background: #555; }
    section { display: none; padding: 1rem; }
    section.active { display: block; }
    .pack, .user-pack { border: 1px solid #444; border-radius: 6px; padding: 10px; margin: 10px 0; max-width: 300px; }
    .pack img, .user-pack img { max-width: 100%; border-radius: 5px; margin-bottom: 5px; }
  </style>
</head>
<body>
  <header>Card Collector Activity</header>
  <nav>
    <button onclick="showSection('packs')">Pacchetti</button>
    <button onclick="showSection('collection')">Collezione</button>
    <button onclick="showSection('admin')">Admin</button>
  </nav>

  <section id="packs" class="active">
    <h2>I tuoi pacchetti</h2>
    <div id="user-packs">Caricamento…</div>
  </section>

  <section id="collection">
    <h2>La tua collezione</h2>
    <div id="user-collection">Caricamento…</div>
  </section>

  <section id="admin">
    <h2>Area Admin</h2>
    <h3>Gestione Pacchetti</h3>
    <form id="create-pack-form">
      <input type="text" name="packName" placeholder="Nome pacchetto" required/>
      <input type="number" name="cardCount" placeholder="Numero carte" required/>
      <input type="url" name="packImageUrl" id="packImageUrl" placeholder="URL immagine pacchetto"/>
      <div id="packImagePreview" style="margin-top:10px;"></div>
      <button type="submit">Crea Pacchetto</button>
    </form>
    <div id="pack-list" style="margin-top:20px;"></div>
    <h3>Gestione Carte</h3>
    <form id="create-card-form" style="margin-top:20px;">
      <input type="text" name="cardName" placeholder="Nome carta" required/>
      <input type="text" name="cardType" placeholder="Tipo carta"/>
      <textarea name="description" placeholder="Descrizione"></textarea>
      <input type="url" name="imageUrl" id="imageUrl" placeholder="URL immagine carta"/>
      <div id="imagePreview" style="margin-top:10px;"></div>
      <select name="packSelect" id="packSelect" required>
        <option value="">Seleziona Pacchetto</option>
      </select>
      <button type="submit">Aggiungi Carta</button>
    </form>
    <div id="card-list" style="margin-top:20px;"></div>
  </section>

<script>
  // Utility
  const SUPABASE_URL = 'https://lwlsnrbrkpzzfxixcoqj.supabase.co';
  const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
  const currentUserId = '353012142066237442';

  function showSection(id) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // Fetch Helpers
  async function fetchUserPacks() {
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/user_packs?user_id=eq.${currentUserId}&select=quantity,pack:pack_id(id,name,image_url,card_count)`,
      { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
    );
    if (!res.ok) throw new Error(await res.text());
    const json = await res.json();
    return Array.isArray(json) ? json : [];
  }

  async function fetchUserCollection() {
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/user_cards?user_id=eq.${currentUserId}&select=quantity,card:card_id(name,type,description,image_url)`,
      { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
    );
    if (!res.ok) throw new Error(await res.text());
    const json = await res.json();
    return Array.isArray(json) ? json : [];
  }

  async function fetchAllPacks() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/packs?select=*`, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function fetchCards(packId) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/cards?pack_id=eq.${packId}`, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  // Renderers
  async function loadUserPacks() {
    const container = document.getElementById('user-packs');
    try {
      const packs = await fetchUserPacks();
      container.innerHTML = packs.length ? '' : '<p>Nessun pacchetto.</p>';
      packs.forEach(p => {
        const div = document.createElement('div');
        div.className = 'user-pack';
        div.innerHTML = `
          ${p.pack.image_url ? `<img src="${p.pack.image_url}">` : ''}
          <strong>${p.pack.name}</strong><br>
          ${p.pack.card_count} carte • ${p.quantity} pezzi<br>
          <button onclick="openPack(${p.pack.id})">Apri</button>
        `;
        container.appendChild(div);
      });
    } catch(e) {
      container.innerHTML = '<p>Errore caricamento pacchetti.</p>';
      console.error(e);
    }
  }

  async function loadUserCollection() {
    const container = document.getElementById('user-collection');
    try {
      const cards = await fetchUserCollection();
      container.innerHTML = cards.length ? '' : '<p>Nessuna carta.</p>';
      cards.forEach(e => {
        const div = document.createElement('div');
        div.className = 'user-pack';
        div.innerHTML = `
          ${e.card.image_url ? `<img src="${e.card.image_url}">` : ''}
          <strong>${e.card.name}</strong> (x${e.quantity})<br>
          ${e.card.type || ''} - ${e.card.description || ''}
        `;
        container.appendChild(div);
      });
    } catch(e) {
      container.innerHTML = '<p>Errore caricamento collezione.</p>';
      console.error(e);
    }
  }

  // Open a pack
  async function openPack(packId) {
    try {
      const cards = await fetchCards(packId);
      if (!cards.length) return alert('Pacchetto vuoto!');
      const card = cards[Math.floor(Math.random()*cards.length)];

      // Add to user_cards
      await fetch(`${SUPABASE_URL}/rest/v1/user_cards`, {
        method: 'POST',
        headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, 'Content-Type':'application/json' },
        body: JSON.stringify({ user_id: currentUserId, card_id: card.id, quantity:1 })
      });

      // Decrement user_packs
      const upRes = await fetch(
        `${SUPABASE_URL}/rest/v1/user_packs?user_id=eq.${currentUserId}&pack_id=eq.${packId}`,
        { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
      );
      const [up] = await upRes.json();
      if (!up) throw 'Pacchetto utente non trovato';
      await fetch(
        `${SUPABASE_URL}/rest/v1/user_packs?user_id=eq.${currentUserId}&pack_id=eq.${packId}`,
        {
          method: up.quantity>1?'PATCH':'DELETE',
          headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, 'Content-Type':'application/json' },
          body: up.quantity>1?JSON.stringify({ quantity: up.quantity-1 }):null
        }
      );

      alert(`Hai ottenuto: ${card.name}`);
      loadUserPacks();
      loadUserCollection();
    } catch(e) {
      console.error(e);
      alert('Errore apertura pacchetto: ' + e);
    }
  }

  // Admin: Create pack
  document.getElementById('create-pack-form').addEventListener('submit', async e => {
    e.preventDefault();
    const f = e.target;
    const name = f.packName.value.trim();
    const cardCount = parseInt(f.cardCount.value);
    const imageUrl = f.packImageUrl.value.trim()||null;
    try {
      await fetch(`${SUPABASE_URL}/rest/v1/packs`, {
        method: 'POST',
        headers:{ apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, 'Content-Type':'application/json', Prefer:'return=representation' },
        body: JSON.stringify({ name, card_count: cardCount, image_url:imageUrl })
      });
      f.reset();
      loadAllPacks();
      alert('Pacchetto creato');
    } catch(err) {
      console.error(err);
      alert('Errore creazione pacchetto');
    }
  });

  // Admin: Create card
  document.getElementById('create-card-form').addEventListener('submit', async e => {
    e.preventDefault();
    const f = e.target;
    const payload = {
      name: f.cardName.value.trim(),
      type: f.cardType.value.trim()||null,
      description: f.description.value.trim()||null,
      image_url: f.imageUrl.value.trim()||null,
      pack_id: parseInt(f.packSelect.value)
    };
    try {
      await fetch(`${SUPABASE_URL}/rest/v1/cards`, {
        method:'POST',
        headers:{ apikey: SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, 'Content-Type':'application/json', Prefer:'return=representation' },
        body: JSON.stringify(payload)
      });
      f.reset();
      alert('Carta aggiunta');
    } catch(err) {
      console.error(err);
      alert('Errore aggiunta carta');
    }
  });

  // Load all packs into admin dropdown & list
  async function loadAllPacks() {
    const list = document.getElementById('pack-list');
    const sel = document.getElementById('packSelect');
    try {
      const packs = await fetchAllPacks();
      list.innerHTML = '<h4>Pacchetti esistenti</h4>';
      sel.innerHTML = '<option value="">Seleziona Pacchetto</option>';
      packs.forEach(p => {
        const div = document.createElement('div');
        div.className='pack';
        div.innerHTML = `
          ${p.image_url?`<img src="${p.image_url}">`:''}
          <strong>${p.name}</strong> - ${p.card_count} carte
        `;
        list.appendChild(div);
        const opt = document.createElement('option');
        opt.value = p.id; opt.textContent = p.name;
        sel.appendChild(opt);
      });
    } catch(e) {
      console.error(e);
      list.textContent = 'Errore caricamento pacchetti.';
    }
  }

  // Init
  (async function(){
    await loadUserPacks();
    await loadUserCollection();
    await loadAllPacks();
  })();
</script>
</body>
</html>
